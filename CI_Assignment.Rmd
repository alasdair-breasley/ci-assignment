---
title: "CI_Assignment"
output: html_document
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = TRUE)

```

## Packages 

```{r include = FALSE}

library(tidyverse)
library(ggplot2)
library(scales)

```

## Initial Data Loading and Checks 

```{r}

# Load data 

# Scotland alcohol related hospital visits by local authority 
filepath = "scotland_hospital_visits_local_authority.csv"
scotland_hospital_visits_local_authority = read.csv(filepath, header = TRUE)

# Scotland alcohol related hospital visits national 
filepath = "scotland_hospital_visits_whole.csv"
scotland_hospital_visits_whole = read.csv(filepath, header = TRUE)

# Scotland population by local authority and national 
filepath = "scotland_population_local_authority_and_whole.csv"
scotland_population_local_authority_whole = read.csv(filepath, header = TRUE)

# England alcohol related hospital visits per 100k by local authority 
filepath = "england_hospital_visits_per100k_local_authority_joined.csv"
england_hospital_visits_local_authority = read.csv(filepath, header = TRUE)

# UK annual population survey data by local authority - 2017 
filepath = "annual_population_survey.csv"
uk_pop_survey_2017 = read.csv(filepath, header = TRUE)

# UK annual hours and earnings data by local authority - 2017 
filepath = "annual_hours_and_earnings_survey.csv"
uk_earnings_survey_2017 = read.csv(filepath, header = TRUE)

# UK annual population survey data by age, sex, local authority - 2017 
filepath = "annual_population_age_sex_survey.csv"
uk_pop_ages_sex_survey_2017 = read.csv(filepath, header = TRUE)

```

```{r}

# Preprocess data 

# Scotland alcohol related hospital visits by local authority 
scotland_hospital_visits_local_authority_clean = scotland_hospital_visits_local_authority %>% 
  dplyr::select(financial_year, local_authority, sg_code, stays) %>% 
  dplyr::mutate(year = str_sub(str_trim(financial_year), start = 1, end = 4)) %>% 
  dplyr::mutate(year = as.numeric(year)) %>% 
  dplyr::mutate(local_authority = dplyr::case_when(local_authority == "Edinburgh City" ~ "City of Edinburgh", 
                   local_authority == "Ayrshire East" ~ "East Ayrshire", 
                   local_authority == "Dunbartonshire East" ~ "East Dunbartonshire", 
                   local_authority == "Lothian East" ~ "East Lothian", 
                   local_authority == "Renfrewshire East" ~ "East Renfrewshire", 
                   local_authority == "Ayrshire North" ~ "North Ayrshire", 
                   local_authority == "Lanarkshire North" ~ "North Lanarkshire", 
                   local_authority == "Borders" ~ "Scottish Borders", 
                   local_authority == "Ayrshire South" ~ "South Ayrshire", 
                   local_authority == "Lanarkshire South" ~ "South Lanarkshire", 
                   local_authority == "Dunbartonshire West" ~ "West Dunbartonshire", 
                   local_authority == "Lothian West" ~ "West Lothian", 
                   TRUE ~ local_authority))

# Check for NAs
colSums(is.na(scotland_hospital_visits_local_authority_clean))

# Scotland alcohol related hospital visits national 
scotland_hospital_visits_whole_clean = scotland_hospital_visits_whole %>% 
  dplyr::select(financial_year, grouping, stays) %>% 
  dplyr::mutate(year = str_sub(str_trim(financial_year), start = 1, end = 4)) %>% 
  dplyr::mutate(year = as.numeric(year))

# Check for NAs
colSums(is.na(scotland_hospital_visits_whole_clean))

# Scotland yearly population by local authority 
scotland_population_local_authority_clean = scotland_population_local_authority_whole %>% 
  dplyr::filter(local_authority != "Scotland") %>% 
  dplyr::mutate(year = as.numeric(year))

# Check for NAs
colSums(is.na(scotland_population_local_authority_clean))

# Check local authority names match 
sort(unique(scotland_hospital_visits_local_authority_clean$local_authority)) == sort(unique(scotland_population_local_authority_clean$local_authority))

# Scotland yearly population national 
scotland_population_whole_clean = scotland_population_local_authority_whole %>% 
  dplyr::filter(local_authority == "Scotland")

# Create Scotland alcohol related hospital visits per 100,00 by local authority 
scotland_hospital_visits_local_authority_per100k = scotland_hospital_visits_local_authority_clean %>% 
  dplyr::left_join(scotland_population_local_authority_clean, by = c("local_authority", "year")) %>% 
  dplyr::mutate(stays_per100k = (stays * 100000) / population)

# Create Scotland alcohol related hospital visits per 100,00 national 
scotland_hospital_visits_whole_per100k = scotland_hospital_visits_whole_clean %>% 
  dplyr::left_join(scotland_population_whole_clean, by = c("year")) %>% 
  dplyr::mutate(stays_per100k = (stays * 100000) / population) %>% 
  dplyr::filter(year >= 1997)

# England alcohol related hospital visits by local authority 
england_hospital_visits_local_authority_per100k = england_hospital_visits_local_authority %>% 
  dplyr::mutate(year = str_sub(str_trim(financial_year), start = 1, end = 4)) %>% 
  dplyr::mutate(stays_per100k = as.numeric(stays_per100k), 
                year = as.numeric(year)) %>% 
  dplyr::filter(!is.na(stays_per100k)) %>% 
  dplyr::group_by(local_authority) %>% 
  dplyr::filter(n() >= 8) %>% 
  dplyr::ungroup() 

# UK annual population survey data by local authority - 2017 
uk_pop_survey_2017_clean = uk_pop_survey_2017 %>% 
  dplyr::mutate(economic_activity_rate_16to64 = as.numeric(economic_activity_rate_16to64), 
                employment_rate_16to64 = as.numeric(employment_rate_16to64), 
                unemployment_rate_16to64 = as.numeric(unemployment_rate_16to64)) %>% 
  dplyr::select(-unemployment_rate_16plus) %>% 
  dplyr::mutate(economic_activity_rate_16to64 = if_else(local_authority == "Orkney Islands" | local_authority == "Shetland Islands", 
                                                        (77.3 + 84.6 + 83.7) / 3, 
                                                        economic_activity_rate_16to64), 
                employment_rate_16to64 = if_else(local_authority == "Orkney Islands" | local_authority == "Shetland Islands", 
                                                        (75.6 + 81.0 + 81.1) / 3, 
                                                        employment_rate_16to64), 
                unemployment_rate_16to64 = if_else(local_authority == "Orkney Islands" | local_authority == "Shetland Islands", 
                                                        (2.3 + 4.2 + 3.0) / 3, 
                                                        unemployment_rate_16to64)) %>% # economic activity rate, employment rate, and unemployment rate are imputed for Orkney and Shetland using the mean of the included local authorities which are also part of the wider highlands and islands area 
  dplyr::filter_all(all_vars(!is.na(.))) 

# UK annual hours and earnings data by local authority - 2017 
uk_earnings_survey_2017_clean = uk_earnings_survey_2017 %>% 
  dplyr::mutate(median_weekly_pay_gross = as.numeric(median_weekly_pay_gross), 
                median_annual_pay_gross = as.numeric(median_annual_pay_gross), 
                mean_weekly_pay_gross = as.numeric(mean_weekly_pay_gross), 
                mean_annual_pay_gross = as.numeric(mean_annual_pay_gross)) %>% 
  dplyr::filter_all(all_vars(!is.na(.))) 

# UK annual population survey data by age, sex, local authority - 2017 
uk_pop_ages_sex_survey_2017_clean = uk_pop_ages_sex_survey_2017 %>% 
  dplyr::mutate(pop_all = as.numeric(pop_all),
                pop_0to15 = as.numeric(pop_0to15),
                pop_16to64 = as.numeric(pop_16to64), 
                pop_65plus = as.numeric(pop_65plus), 
                pop_all_m = as.numeric(pop_all_m), 
                pop_0to15_m = as.numeric(pop_0to15_m), 
                pop_16to64_m = as.numeric(pop_16to64_m), 
                pop_65plus_m = as.numeric(pop_65plus_m), 
                pop_all_f = as.numeric(pop_all_f), 
                pop_0to15_f = as.numeric(pop_0to15_f), 
                pop_16to64_f = as.numeric(pop_16to64_f), 
                pop_65plus_f = as.numeric(pop_65plus_f)) %>% 
  dplyr::filter_all(all_vars(!is.na(.))) %>% 
  dplyr::mutate(percentage_male = pop_all_m / (pop_all_m + pop_all_f), 
                percentage_0to15 = pop_0to15 / pop_all, 
                percentage_16to64 = pop_16to64 / pop_all, 
                percentage_65plus = pop_65plus / pop_all) 

# Create local authority matching dataset 
local_authority_characteristics = uk_pop_survey_2017_clean %>%  
  dplyr::inner_join(uk_earnings_survey_2017_clean, by = c("local_authority", "area_code")) %>% 
  dplyr::inner_join(uk_pop_ages_sex_survey_2017_clean, by = c("local_authority", "area_code")) 

# test1 = unique(scotland_hospital_visits_local_authority_per100k$local_authority)
# 
# test2 = unique(local_authority_characteristics$local_authority)
# 
# unique(scotland_hospital_visits_local_authority_per100k$local_authority)
# 
# test1 %in% test2

# test3 = unique(england_hospital_visits_local_authority_per100k$local_authority)
# 
# test4 = unique(local_authority_characteristics$local_authority)
# 
# unique(england_hospital_visits_local_authority_per100k$local_authority)
# 
# unique(local_authority_characteristics$local_authority)
# 
# test3 %in% test4

# Filter England alcohol related hospital visits by local authority to only include local authorities with complete matching data 
england_hospital_visits_local_authority_per100k_has_characteristics = england_hospital_visits_local_authority_per100k %>% 
  dplyr::filter(local_authority %in% unique(local_authority_characteristics$local_authority))

# Number of England local authorities with per 100k data 
length(unique(england_hospital_visits_local_authority_per100k$local_authority))

# Number of England local authorities with per 100k data and complete matching data 
length(unique(england_hospital_visits_local_authority_per100k_has_characteristics$local_authority))

# Filter local authority matching dataset 
local_authority_characteristics_has_per100k = local_authority_characteristics %>% 
  dplyr::filter(local_authority %in% unique(england_hospital_visits_local_authority_per100k$local_authority) | local_authority %in% unique(scotland_hospital_visits_local_authority_per100k$local_authority))

# Number of Scotland and England local authorities with per 100k data and complete matching data 
length(unique(local_authority_characteristics_has_per100k$local_authority))

```

```{r}

# Scotland alcohol related hospital visits per 100,000 by local authority 
ggplot(data = scotland_hospital_visits_local_authority_per100k, aes(x = year, y = stays_per100k, colour = local_authority)) +
  geom_line() +
  scale_x_continuous(breaks = breaks_width(4), minor_breaks = NULL) +
  scale_y_continuous(breaks = breaks_width(100)) +
  labs(x = "Year", y = "Hospital stays per 100,000", title = "Alcohol Related Hospital Visits per 100,000 by Local Authority - Scotland") +
  theme(panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5), axis.text = element_text(color = "black", size = 10),
        axis.title = element_text(size = 12), plot.title = element_text(size = 12, face = "bold"), legend.title = element_blank())

```

```{r}

# Scotland alcohol related hospital visits per 100,000 by local authority 
ggplot(data = scotland_hospital_visits_whole_per100k, aes(x = year, y = stays_per100k)) +
  geom_line() +
  scale_x_continuous(breaks = breaks_width(4), minor_breaks = NULL) +
  scale_y_continuous(breaks = breaks_width(100), limits = c(0, 1000)) +
  labs(x = "Year", y = "Hospital stays per 100,000", title = "Alcohol Related Hospital Visits per 100,000 by Local Authority - Scotland") +
  theme(panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5), axis.text = element_text(color = "black", size = 10),
        axis.title = element_text(size = 12), plot.title = element_text(size = 12, face = "bold"), legend.title = element_blank())

```

```{r}

# Visualise Scotland vs England total 
scot_total = scotland_hospital_visits_whole_per100k %>% 
  dplyr::rename(country = local_authority) %>% 
  dplyr::select(c(country, year, stays_per100k)) %>% 
  dplyr::filter(year >= 2012 & year <= 2019)

country = c("England", "England", "England", "England", "England", "England", "England", "England")
year = c(2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019)
stays_per100k = c(610, 620, 580, 560, 490, 490, 510, 520)

eng_total = data.frame(country, year, stays_per100k)

scot_eng_total = rbind(scot_total, eng_total)

# Scotland and England alcohol related hospital visits per 100,000 by local authority 
ggplot(data = scot_eng_total, aes(x = year, y = stays_per100k, colour = country)) +
  geom_line() +
  scale_x_continuous(breaks = breaks_width(1), minor_breaks = NULL) +
  scale_y_continuous(breaks = breaks_width(100), limits = c(0, 800)) +
  labs(x = "Year", y = "Hospital stays per 100,000", title = "Alcohol Related Hospital Visits per 100,000 Scotland vs England") +
  theme(panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5), axis.text = element_text(color = "black", size = 10),
        axis.title = element_text(size = 12), plot.title = element_text(size = 12, face = "bold"), legend.title = element_blank())

```

